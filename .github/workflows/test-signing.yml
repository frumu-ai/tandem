name: Test Signing Keys

on:
  workflow_dispatch:

jobs:
  test-signing:
    name: Verify Signing Keys
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Extract public key from tauri.conf.json
        id: pubkey
        run: |
          PUBKEY=$(jq -r '.plugins.updater.pubkey' src-tauri/tauri.conf.json)
          echo "pubkey=$PUBKEY" >> $GITHUB_OUTPUT
          echo "Found public key: ${PUBKEY:0:50}..."

      - name: Test signing and verification
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          PUBLIC_KEY: ${{ steps.pubkey.outputs.pubkey }}
        run: |
          echo "Step 1: Basic secret diagnostics (no secret output)..."
          python - <<'PY'
          import os, re
          key = os.environ.get("TAURI_SIGNING_PRIVATE_KEY", "")
          print(f"Key length: {len(key)}")
          print(f"Starts with 'dW50'?: {key.startswith('dW50')}")
          print(f"Looks like Windows path?: {(':\\\\' in key) or (key.startswith('C:\\\\')) or ('.tauri' in key)}")
          invalid = re.sub(r"[A-Za-z0-9+/=\\r\\n]", "", key)
          print(f"Non-base64 chars count (excluding newlines): {len(invalid)}")
          if invalid:
            # Print only the first invalid char codepoint, not the char itself.
            print(f"First invalid char codepoint: {ord(invalid[0])}")
          PY

          echo "Step 2: Writing private key to file..."
          printf '%s\n' "$TAURI_SIGNING_PRIVATE_KEY" > /tmp/private.key

          echo "Step 3: Creating test file..."
          echo "test content" > test.txt

          echo "Step 4: Signing test file with private key..."
          tauri signer sign -k /tmp/private.key test.txt

          echo "Step 5: Verifying signature with public key..."
          tauri signer verify test.txt "$PUBLIC_KEY"

          echo "âœ… SUCCESS! Private key, password, and public key all match!"

          # Cleanup
          rm /tmp/private.key
